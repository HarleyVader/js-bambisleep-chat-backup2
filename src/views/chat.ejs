<!DOCTYPE html>
<html lang="en">
<%- include('partials/head') %>
<title><%= title || 'Chat' %> | BambiSleep</title>

<body>
  <%- include('partials/nav', { path: '/chat' }) %>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <div class="chat-container">
        <div class="chat-header">
          <h2>BambiSleep Chat</h2>
        </div>
        
        <div class="chat-messages">
          <ul id="chat-response">
            <% if (chatMessages && chatMessages.length > 0) { %>
              <% chatMessages.forEach(msg => { %>
                <li>
                  <span class="chat-time"><%= new Date(msg.timestamp).toLocaleTimeString([], {hour12: false}) %></span> -
                  <span class="chat-username"><a href="/profile/<%= msg.username %>" class="username-link"><%= msg.username %></a>:</span>
                  <span class="chat-message"><%= msg.data %></span>
                </li>
              <% }); %>
            <% } else { %>
              <li class="system-message">No messages yet. Be the first to chat!</li>
            <% } %>
          </ul>
        </div>
        
        <div class="chat-input">
          <form id="chat-form">
            <div class="input-group">
              <input type="text" id="chat-message" class="form-control" placeholder="Type your message..." autocomplete="off">
              <div class="input-group-append">
                <button class="btn btn-primary" type="submit">Send</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Scripts -->
<script src="/socket.io/socket.io.js"></script>
<script src="/js/chat.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize socket
    const socket = io();
    window.socket = socket;
    
    // Chat form submission
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-message');
    
    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const message = chatInput.value.trim();
      if (message) {
        socket.emit('chat message', { data: message });
        chatInput.value = '';
      }
    });

    // TTS functionality
    function speakText(text, count = 1) {
      if ('speechSynthesis' in window) {
        let spoken = 0;
        const speakOnce = () => {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.rate = 0.8;
          utterance.pitch = 1;
          utterance.onend = () => {
            spoken++;
            if (spoken < count) {
              setTimeout(speakOnce, 500);
            }
          };
          speechSynthesis.speak(utterance);
        };
        speakOnce();
      }
    }

    // Add glow effect to user
    function addGlowEffect() {
      document.body.classList.add('mentioned');
      setTimeout(() => {
        document.body.classList.remove('mentioned');
      }, 3000);
    }

    // Show countdown in chat
    function showCountdown(count, trigger) {
      const countdownLi = document.createElement('li');
      countdownLi.className = 'system-message countdown-message';
      countdownLi.innerHTML = `<span class="countdown">Speaking "${trigger}" ${count} times...</span>`;
      document.getElementById('chat-response').appendChild(countdownLi);
      
      let remaining = count;
      const countdownInterval = setInterval(() => {
        remaining--;
        if (remaining > 0) {
          countdownLi.innerHTML = `<span class="countdown">Speaking "${trigger}" ${remaining} more times...</span>`;
        } else {
          countdownLi.innerHTML = `<span class="countdown">Finished speaking "${trigger}"</span>`;
          clearInterval(countdownInterval);
          setTimeout(() => {
            countdownLi.remove();
          }, 2000);
        }
      }, 1000);
    }

    // Handle special chat events
    socket.on('chat mention', function(data) {
      if (data.mentionedUser === '<%= username %>') {
        addGlowEffect();
      }
    });

    socket.on('chat trigger', function(data) {
      speakText(data.trigger);
    });

    socket.on('chat mention trigger', function(data) {
      if (data.mentionedUser === '<%= username %>') {
        addGlowEffect();
        const count = data.count || 1;
        if (count > 1) {
          showCountdown(count, data.trigger);
        }
        speakText(data.trigger, count);
      }
    });

    // Handle regular chat messages
    socket.on('chat message', function(data) {
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="chat-time">${new Date(data.timestamp).toLocaleTimeString([], {hour12: false})}</span> -
        <span class="chat-username"><a href="/profile/${data.username}" class="username-link">${data.username}</a>:</span>
        <span class="chat-message">${data.data}</span>
      `;
      document.getElementById('chat-response').appendChild(li);
      
      // Scroll to bottom
      const chatResponse = document.getElementById('chat-response');
      chatResponse.scrollTop = chatResponse.scrollHeight;
    });
  });
</script>

<style>
  .mentioned {
    animation: glow 3s ease-in-out;
  }
  
  @keyframes glow {
    0%, 100% { box-shadow: none; }
    50% { box-shadow: 0 0 20px rgba(255, 105, 180, 0.8); }
  }
  
  .countdown-message {
    font-style: italic;
    color: #007bff;
  }
  
  .countdown {
    font-weight: bold;
  }
  
  .chat-messages {
    max-height: 400px;
    overflow-y: auto;
  }
  
  .chat-container {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .chat-header {
    margin-bottom: 20px;
    text-align: center;
  }
  
  .chat-header h2 {
    color: #00ccff;
    margin: 0;
  }
  
  .chat-input {
    margin-top: 20px;
  }
  
  .system-message {
    color: #888;
    font-style: italic;
  }
  
  .unsafe-url-warning {
    color: #ff7777;
    font-weight: bold;
  }
</style>

<link rel="stylesheet" href="/css/chat.css">

<%- include('partials/footer'); %>
