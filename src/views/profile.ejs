<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/components/profile.css">
</head>
<body>
    <%- include('partials/nav') %>
    
    <div class="container mt-4">
        <!-- Profile Header -->
        <div class="profile-header profile-style-<%= profile.profileStyle %>">
            <div class="row">
                <div class="col-md-8">
                    <h1 class="profile-username"><%= profile.username %></h1>
                    <div class="profile-stats">
                        <span class="stat-item">
                            <strong>Level:</strong> <%= profile.level || 0 %>
                        </span>
                        <span class="stat-item">
                            <strong>XP:</strong> <%= profile.xp || 0 %>
                        </span>
                        <span class="stat-item">
                            <strong>Joined:</strong> <%= new Date(profile.usageStats?.joinDate || profile.createdAt).toLocaleDateString() %>
                        </span>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="profile-reactions">
                        <button class="btn btn-outline-danger reaction-btn" data-type="love">
                            ‚ù§Ô∏è <span class="love-count"><%= profile.loves || 0 %></span>
                        </button>
                        <button class="btn btn-outline-primary reaction-btn" data-type="like">
                            üëç <span class="like-count"><%= profile.likes || 0 %></span>
                        </button>
                    </div>
                    <% if (isOwner) { %>
                    <div class="mt-2">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                            Edit Profile
                        </button>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="row mt-4">
            <!-- Main Profile Content -->
            <div class="col-md-8">
                <!-- Bio Section -->
                <div class="profile-section">
                    <h3>Bio</h3>
                    <div class="profile-bio">
                        <% if (bioHtml) { %>
                            <%- bioHtml %>
                        <% } else { %>
                            <p class="text-muted">No bio available yet.</p>
                        <% } %>
                    </div>
                </div>

                <!-- Usage Statistics -->
                <div class="profile-section">
                    <h3>Usage Statistics</h3>
                    <div class="usage-stats">
                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-number"><%= profile.usageStats?.sessionsCount || 0 %></div>
                                <div class="stat-label">Sessions</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number"><%= Math.round((profile.usageStats?.totalTimeSpent || 0) / 60) %></div>
                                <div class="stat-label">Hours Spent</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number"><%= profile.usageStats?.triggersActivated || 0 %></div>
                                <div class="stat-label">Triggers</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number"><%= profile.usageStats?.messagesPosted || 0 %></div>
                                <div class="stat-label">Messages</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <!-- Social Links -->
                <div class="profile-section">
                    <h4>Social Links</h4>
                    <div class="social-links">
                        <% if (profile.socialLinks?.twitter) { %>
                        <a href="<%= profile.socialLinks.twitter %>" target="_blank" class="social-link twitter">
                            <i class="fab fa-twitter"></i> Twitter
                        </a>
                        <% } %>
                        <% if (profile.socialLinks?.instagram) { %>
                        <a href="<%= profile.socialLinks.instagram %>" target="_blank" class="social-link instagram">
                            <i class="fab fa-instagram"></i> Instagram
                        </a>
                        <% } %>
                        <% if (profile.socialLinks?.discord) { %>
                        <a href="<%= profile.socialLinks.discord %>" target="_blank" class="social-link discord">
                            <i class="fab fa-discord"></i> Discord
                        </a>
                        <% } %>
                        <% if (profile.socialLinks?.reddit) { %>
                        <a href="<%= profile.socialLinks.reddit %>" target="_blank" class="social-link reddit">
                            <i class="fab fa-reddit"></i> Reddit
                        </a>
                        <% } %>
                        <% if (profile.socialLinks?.custom) { %>
                        <a href="<%= profile.socialLinks.custom %>" target="_blank" class="social-link custom">
                            <i class="fas fa-link"></i> Website
                        </a>
                        <% } %>
                        <% if (!profile.socialLinks || Object.values(profile.socialLinks).every(link => !link)) { %>
                        <p class="text-muted">No social links added yet.</p>
                        <% } %>
                    </div>
                </div>

                <!-- Profile Style Preview -->
                <div class="profile-section">
                    <h4>Profile Style</h4>
                    <div class="style-preview">
                        <span class="badge bg-secondary"><%= profile.profileStyle || 'standard' %></span>
                        <% if (isOwner) { %>
                        <p class="small text-muted mt-1">Change in edit profile</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <% if (isOwner) { %>
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <!-- Bio Section -->
                        <div class="mb-3">
                            <label for="bio" class="form-label">Bio (Markdown supported)</label>
                            <textarea class="form-control" id="bio" name="bio" rows="5" placeholder="Tell everyone about yourself..."><%= profile.bio || '' %></textarea>
                        </div>

                        <!-- Bio File Upload -->
                        <div class="mb-3">
                            <label for="bioFile" class="form-label">Or upload .md file</label>
                            <input type="file" class="form-control" id="bioFile" accept=".md">
                            <div class="form-text">Upload a markdown file to replace your bio</div>
                        </div>

                        <!-- Social Links -->
                        <h6>Social Links</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="twitter" class="form-label">Twitter</label>
                                <input type="url" class="form-control" id="twitter" name="socialLinks[twitter]" 
                                       value="<%= profile.socialLinks?.twitter || '' %>" placeholder="https://twitter.com/username">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="instagram" class="form-label">Instagram</label>
                                <input type="url" class="form-control" id="instagram" name="socialLinks[instagram]" 
                                       value="<%= profile.socialLinks?.instagram || '' %>" placeholder="https://instagram.com/username">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="discord" class="form-label">Discord</label>
                                <input type="text" class="form-control" id="discord" name="socialLinks[discord]" 
                                       value="<%= profile.socialLinks?.discord || '' %>" placeholder="username#1234">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="reddit" class="form-label">Reddit</label>
                                <input type="url" class="form-control" id="reddit" name="socialLinks[reddit]" 
                                       value="<%= profile.socialLinks?.reddit || '' %>" placeholder="https://reddit.com/u/username">
                            </div>
                            <div class="col-12 mb-3">
                                <label for="custom" class="form-label">Custom Website</label>
                                <input type="url" class="form-control" id="custom" name="socialLinks[custom]" 
                                       value="<%= profile.socialLinks?.custom || '' %>" placeholder="https://yourwebsite.com">
                            </div>
                        </div>

                        <!-- Profile Style -->
                        <div class="mb-3">
                            <label for="profileStyle" class="form-label">Profile Style</label>
                            <select class="form-select" id="profileStyle" name="profileStyle">
                                <option value="minimal" <% if (profile.profileStyle === 'minimal') { %>selected<% } %>>Minimal - Clean and simple</option>
                                <option value="standard" <% if (profile.profileStyle === 'standard' || !profile.profileStyle) { %>selected<% } %>>Standard - Balanced design</option>
                                <option value="premium" <% if (profile.profileStyle === 'premium') { %>selected<% } %>>Premium - Rich and detailed</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProfile">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    <% } %>

    <%- include('partials/footer') %>

    <script src="/js/bootstrap.bundle.min.js"></script>
    <script>
        // Reaction buttons
        document.querySelectorAll('.reaction-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const type = btn.dataset.type;
                const username = '<%= profile.username %>';
                
                try {
                    const response = await fetch(`/profile/${username}/reaction`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        document.querySelector('.like-count').textContent = result.likes;
                        document.querySelector('.love-count').textContent = result.loves;
                    }
                } catch (error) {
                    console.error('Error adding reaction:', error);
                }
            });
        });

        <% if (isOwner) { %>
        // Save profile changes
        document.getElementById('saveProfile').addEventListener('click', async () => {
            const form = document.getElementById('editProfileForm');
            const formData = new FormData(form);
            const bioFile = document.getElementById('bioFile').files[0];
            
            try {
                // Handle file upload first if there's a file
                if (bioFile) {
                    const fileFormData = new FormData();
                    fileFormData.append('bioFile', bioFile);
                    
                    const fileResponse = await fetch(`/profile/<%= profile.username %>/upload-bio`, {
                        method: 'POST',
                        body: fileFormData
                    });
                    
                    if (!fileResponse.ok) {
                        throw new Error('Failed to upload bio file');
                    }
                }
                
                // Update other profile data
                const profileData = {
                    bio: formData.get('bio'),
                    profileStyle: formData.get('profileStyle'),
                    socialLinks: {
                        twitter: formData.get('socialLinks[twitter]'),
                        instagram: formData.get('socialLinks[instagram]'),
                        discord: formData.get('socialLinks[discord]'),
                        reddit: formData.get('socialLinks[reddit]'),
                        custom: formData.get('socialLinks[custom]')
                    }
                };
                
                const response = await fetch(`/profile/<%= profile.username %>/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });
                
                if (response.ok) {
                    location.reload(); // Refresh to show changes
                } else {
                    throw new Error('Failed to update profile');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            }
        });
        <% } %>
    </script>
</body>
</html>
